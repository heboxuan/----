var Threads={},_lastItem=0,_loadComplete,state="",threadPlace,longitude,latitude;function _loadList(e){$("#list_content").append("<div style='text-align:center' id='loading_img'><img src='-+CONTEXT_PATH+-/static/www/images/loading.gif'/*tpa=http://liuyan.people.com.cn/static/www/js/"+CONTEXT_PATH+"/static/www/images/loading.gif*/ /></div>"),$("#show_more").hide();var t=$(".shisiwu_domain").val();null!=t&&null!=t&&"0"!=t&&(e.domainId=t);var a=$(".qySub_domain").val();null!=a&&null!=a&&"0"!=a&&(e.subDomainId=a);var r=$(".userType").val();null!=r&&null!=r&&"0"!=r&&(e.userType=r),_loadComplete=!1,e.lastItem=_lastItem,Ajax.post(CONTEXT_PATH+"/threads/queryThreadsList",e,function(a){$("#loading_img").remove(),"success"==a.result?0<a.responseData.length?($.each(a.responseData,function(e,t){$("#list_content").append(tmpl("threads_content_tpl",t)),$("#show_more").show(),e==a.responseData.length-1&&(_lastItem=t.tid)}),a.responseData.length<10&&$("#show_more").hide()):($("#list_content").append("<div style='text-align:center;font: normal 16px/200% \"微软雅黑\";'>没有更多留言</div>"),$("#show_more").hide()):layer.alert(a.responseData,{icon:5}),_loadComplete=!0})}function _initSelectForum(e){Ajax.post(CONTEXT_PATH+"/forum/getForumsForSelect",{fid:e},function(e){if(e.result="success")for(var t=e.responseData,a=t.list,r=t.ids,o=0;o<3;o++){var i=a[o],n="";for(var s in n+=0==o?"<option value=''>请选择省份</option>":"<option value=''>请选择</option>",i)n+="<option value='"+i[s].fid+"'>"+i[s].name+"</option>";$("#s"+o).empty(),$("#s"+o).append(n),$("#s"+o).val(r[o])}})}function _resolveErrorMsg(e){"T0001"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您输入的信息不完整",{icon:5})):"T0002"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，请确定您选择的留言版块是否正确",{icon:5})):"T0003"==e||"T0004"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，请确定您输入的分类或领域等信息是否正确",{icon:5})):"T0005"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您留言的话题活动已经结束",{icon:5})):"T0006"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，请确定您的留言来源是否正确",{icon:5})):"T0007"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，留言状态错误",{icon:5})):"T0008"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，请检查留言标题是否符合要求",{icon:5})):"T0009"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，请检查留言内容是否符合要求",{icon:5})):"T0010"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您输入的内容中包含了禁止词语",{icon:5})):"T0011"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，请不要频繁发表留言",{icon:5})):"T0012"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您没有权限进行此操作",{icon:5})):"T0013"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您输入的验证码错误",{icon:5})):"T0019"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您输入的验证码已失效",{icon:5})):"FB0001"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您输入的信息不完整",{icon:5})):"FB0002"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，该留言状态错误",{icon:5})):"FB0003"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，请检查输入的内容长度是否符合要求",{icon:5})):"FB0004"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您输入的内容中包含了禁止词语",{icon:5})):"FB0005"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，您没有当前操作的权限",{icon:5})):"FB0006"==e?($("#refreshImg").trigger("click"),layer.alert("提交失败，当前留言状态不允许进行评价",{icon:5})):"ORG_REFUSED"==e?($("#refreshImg").trigger("click"),layer.alert("机构用户不允许发留言",{icon:5})):($("#refreshImg").trigger("click"),layer.alert("提交失败",{icon:5})),console.log("error_code:"+e)}Threads.setState=function(e){null!=e&&(state=e)},Threads.initThreadsListPage=function(){var a=Common.getPageParamsByRequest(["fid"]).fid;""==state&&(state=Common.getPageParamsByAnchor(["state"]).queryParam.state,isNaN(state)&&(state="")),$("#tab_type li").click(function(){var e={fid:a},t=$("#tab_type li").index(this);0==t?e.state=1:1==t?e.state=2:2==t?e.state=3:3==t&&(e.state=4),$("#tab_type .t01").removeClass("t01"),$(this).addClass("t01"),$("#list_content").empty(),_lastItem=0,_loadList(e),Common.addAnchorByParams(e,["state"]),$("#show_more").unbind("click"),$("#show_more").show(),$("#show_more").click(function(){_loadComplete&&_loadList(e)})}),$(".shisiwu_domain").on("change",function(){var e={fid:a};$("#list_content").empty(),_lastItem=0,_loadList(e),Common.addAnchorByParams(e,["state"]),$("#show_more").unbind("click"),$("#show_more").click(function(){_loadComplete&&_loadList(e)})}),$(".qySub_domain").on("change",function(){var e={fid:a};$("#list_content").empty(),_lastItem=0,_loadList(e),Common.addAnchorByParams(e,["state"]),$("#show_more").unbind("click"),$("#show_more").click(function(){_loadComplete&&_loadList(e)})});var e={fid:a},t=0;null!=state&&null!=state&&""!=state&&(t=(e.state=state)-1);var r=$("#tab_type li").get(t);$(r).addClass("t01"),$("#list_content").empty(),_loadList(e),$("#show_more").click(function(){_loadComplete&&_loadList(e)})},Threads.initListPostPage=function(e){Threads.initPostPage(e)},Threads.initPostPage=function(e){0==e&&_initSelectForum(e),$("curLen").css("color","#D9313F"),$("#content").on("input",function(){var e=$("#content").val(),t=Math.ceil(Common.getWordCount(e));1e3<t||t<20?$("#curLen").css("color","#D9313F"):$("#curLen").css("color","#7a7a7a"),$("#curLen").html(t),$("#leftLen").html(0<=1e3-t?1e3-t:0)}),$("curLen1").css("color","#D9313F"),$("#appeal").on("input",function(){var e=$("#appeal").val(),t=Math.ceil(Common.getWordCount(e));200<t||t<20?$("#curLen1").css("color","#D9313F"):$("#curLen1").css("color","#7a7a7a"),$("#curLen1").html(t),$("#leftLen1").html(0<=200-t?200-t:0)}),$("curLen2").css("color","#D9313F"),$("#complainContent").on("input",function(){var e=$("#complainContent").val(),t=Math.ceil(Common.getWordCount(e));800<t||t<20?$("#curLen2").css("color","#D9313F"):$("#curLen2").css("color","#7a7a7a"),$("#curLen2").html(t),$("#leftLen2").html(0<=800-t?800-t:0)}),$("curLen3").css("color","#D9313F"),$("#hiddenRemark").on("input",function(){var e=$("#hiddenRemark").val(),t=Math.ceil(Common.getWordCount(e));200<t||t<10?$("#curLen3").css("color","#D9313F"):$("#curLen3").css("color","#7a7a7a"),$("#curLen3").html(t),$("#leftLen3").html(0<=200-t?200-t:0)}),$("#attch_btn").click(function(){$(".t05").is(":hidden")?$(".t05").show():$(".t05").hide()}),$("#postForm").find("input,select,textarea").change(function(){layer.closeAll("tips")}),$("#provision_click").click(function(){layer.open({type:1,shade:!1,title:!1,content:$("#provision_info"),area:["680px","490px"],scrollbar:!1})}),$("#submit-msg").click(function(){var e;if(layer.closeAll("tips"),0<$(".forum-select").length){for(var t=0;t<$(".forum-select").length;t++){var a=$($(".forum-select").get(t));if(1<$(a).find("option").length){var r=a.val();if(""==r||isNaN(r))return $("#s"+t).focus(),void layer.tips("请选择留言的版块","#s"+t,{time:5e3,tips:[1,"#FF6666"]});e=r}}$("#fid").val(e)}var o,i,n=$("#subject").val(),s=$("#content").val(),l=$("#appeal").val();if(""==n||22<Common.getWordCount(n))return $("#subject").focus(),void layer.tips("请输入标题，标题字数请不要多于22个字","#subject",{time:5e3,tips:[1,"#FF6666"]});if(""==(o=$('input[type="radio"]:checked').val())||isNaN(o))return $("#typeId").focus(),void layer.tips("请选择主题类别","#typeId",{time:5e3,tips:[1,"#FF6666"]});if(0==$("#form_position").val()&&(""==(i=$("#domainId").val())||isNaN(i)))return $("#a").focus(),void layer.tips("请选择主题领域","#a",{time:5e3,tips:[1,"#FF6666"]});if(2!=o){if(""==s||Common.getWordCount(s)<20)return $("#content").focus(),void layer.tips("请输入留言内容，留言字数请不要少于20个字","#content",{time:5e3,tips:[1,"#FF6666"]});if(1e3<Common.getWordCount(s))return $("#content").focus(),void layer.tips("您的留言超过了1000个字的字数限制，请删减后再重新提交。","#content",{time:5e3,tips:[1,"#FF6666"]})}if(2==o){if(""==l||Common.getWordCount(l)<20)return $("#appeal").focus(),void layer.tips("请输入留言内容，留言字数请不要少于20个字","#appeal",{time:5e3,tips:[1,"#FF6666"]});if(200<Common.getWordCount(l))return $("#appeal").focus(),void layer.tips("您的留言超过了200个字的字数限制，请删减后再重新提交。","#appeal",{time:5e3,tips:[1,"#FF6666"]})}var c=$("#realName").val(),d=$("#phone").val();if(""==c)return $("#realName").focus(),void layer.tips("请填写真实姓名","#realName",{time:5e3,tips:[1,"#FF6666"]});if(!/^[\u4e00-\u9fa5]{2,10}(\u00b7[\u4e00-\u9fa5]{1,10})*$/.test(c))return $("#realName").focus(),void layer.tips("请填写正确的姓名","#realName",{time:5e3,tips:[1,"#FF6666"]});if(""==d)return $("#phone").focus(),void layer.tips("请填写联系电话","#phone",{time:5e3,tips:[1,"#FF6666"]});if(!/^((([0-9]{3,4}-?)?[0-9]{8})|(([0-9]{3,4}-?)?[0-9]{7}))$/.test(d)&&!/^((\+?86)|(\(\+86\)))?(1[0-9]{10})$/.test(d))return $("#phone").focus(),void layer.tips("请填写正确的电话","#phone",{time:5e3,tips:[1,"#FF6666"]});var u="";$(".attched").each(function(e){var t=$(this).attr("data-file"),a=$(this).attr("data-orgfile"),r=$(this).find('input[type="checkbox"]').data("public");u+='{"fileName":"'+t+'","orgFileName":"'+a+'","isPublic":"'+r+'"},'}),""!=u&&$("#uploadFiles").val("["+u.substring(0,u.length-1)+"]");var m=$("#varCode").val(),p=($("#verCode").val(),$("#phoneCode").val()),f=document.getElementById("phoneNumber");return"none"!=document.getElementById("code").style.display&&""==m?($("#varCode").focus(),void layer.tips("请填写验证码","#varCode",{time:5e3,tips:[1,"#FF6666"]})):"none"!=f.style.display&&""==p?($("#phoneCode").focus(),void layer.tips("请填写手机验证码","#phoneCode",{time:5e3,tips:[1,"#FF6666"]})):($("#submit-msg").attr("disabled",!0),layer.msg("提交中请稍后...",{time:6e4,icon:16,shade:.3}),void Ajax.formAjaxSubmit("#postForm",function(e){if("success"==e.result){var t=e.responseData;$("#add_fid").val(t.fid),$("#add_tid").val(t.tid),$("#add_anonymousCode").val(t.anonymousCode),$("#s_form").attr("action",CONTEXT_PATH+"/threads/postSuccess"),$("#s_form").submit()}else{"yes"==(t=e.responseData).needcertif&&layer.msg("请先进行手机绑定，正在跳转...",{time:1e3,icon:6,shade:.01},function(){location.href=CONTEXT_PATH+"/certif?retUrl="+t.referer}),$("#submit-msg").attr("disabled",!1),_resolveErrorMsg(e.responseData)}}))}),$("#realName").on("focus",function(){layer.tips("因办理需要，您的联系方式和备注信息会发给领导或办理机构，但不会给任何第三方","#realName",{time:6e3,tips:[1,"#FF6666"]})}),$("#realName").on("blur",function(){layer.closeAll("tips"),$("#realName").val($("#realName").val().trim())}),$("#refreshImg").click(function(){var e=(new Date).valueOf();$("#codeImg").attr("src",CONTEXT_PATH+"/verifycode/rand4?t="+e)})},function(e){"use strict";e.search=e.search||{};var t="",a="",r="",o="",i="",n="",s=0,l=!1,c=!1;function d(){if(!c){if(t=$("#keywords").val(),a=$("#nickName").val(),r=$("#timeRange").val(),""!=t&&t.length<1)return $("#keywords").focus(),layer.tips("关键词不能少于1个字","#keywords",{time:2e3,tips:[2,"#FF6666"]}),!1;if(-1==r&&(o=$("#stTimeStr").val(),i=$("#edTimeStr").val(),""==o&&""==i))return $("#edTimeStr").focus(),layer.tips("请输入搜索起始时间","#edTimeStr",{time:2e3,tips:[2,"#FF6666"]}),!1;$("#list_content").empty(),s=0,l=!1,u(),$("#show_more").click(function(){l&&u()})}}function u(){$("#list_content").append("<div style='text-align:center;padding-top:5%' id='loading_img'><img src='-+CONTEXT_PATH+-/static/www/images/loading.gif'/*tpa=http://liuyan.people.com.cn/static/www/js/"+CONTEXT_PATH+"/static/www/images/loading.gif*/ /></div>"),$("#show_more").hide(),c=!(l=!1);var e={};e.lastItem=s,e.queryType=2,""!=t&&1<=t.length&&(e.keywords=t),""!=a&&(e.nickName=a),""!=r&&-1==(e.timeRange=r)&&(console.log(o),""!=o&&(e.stTimeStr=o),""!=i&&(e.edTimeStr=i)),""!==n&&(e.fid=n),Ajax.get(CONTEXT_PATH+"/threads/search",e,function(a){if($("#loading_img").remove(),"success"==a.result){if(!isNaN(t)&&1==a.responseData.pageSize&&1==a.responseData.page)return void(location.href=CONTEXT_PATH+"/threads/content?tid="+t);0<a.responseData.rows.length?($.each(a.responseData.rows,function(e,t){$("#list_content").append(tmpl("threads_content_tpl",t)),$("#show_more").show(),e==a.responseData.rows.length-1&&(s=t.tid)}),a.responseData.total<a.responseData.pageSize&&$("#show_more").hide()):($("#list_content").append("<div style='text-align:center;font: normal 16px/200% \"微软雅黑\";'>没有更多留言</div>"),$("#show_more").hide())}else layer.alert(a.responseData,{icon:5});c=!(l=!0)})}e.search.initPage=function(e){$("#div_custom").hide(),console.log($("#keywords").val()),""!=$("#keywords").val()&&d(),$("#submitBtn").bind("click",d)}}(window.Threads=window.Threads||{}),Threads.initThreadsSearchPage=function(e,t){_initSelectForum(e),$("#searchform").find("input,select,textarea").change(function(){layer.closeAll("tips")}),$("#submitBtn").click(function(){layer.closeAll("tips");var e="";if(1<$("#s2").find("option").length){if(""==$("#s2").val()||isNaN($("#s2").val()))return $("#s2").focus(),layer.tips("请选择一个具体的留言的版块","#s2",{time:2e3,tips:[1,"#FF6666"]}),!1;e=$("#s2").val()}else{if(""!=$("#s0").val()&&(""==$("#s1").val()||isNaN($("#s1").val())))return $("#s1").focus(),layer.tips("请选择一个具体的留言的版块","#s1",{time:2e3,tips:[1,"#FF6666"]}),!1;e=$("#s1").val()}var t=$("#keywords").val(),a=$("#nickName").val(),r=$("#timeRange").val();if(""==e&&""==a&&""==t&&0==r)return layer.alert("请输入查询条件：关键词，笔名，查询时间或版块",{icon:5}),!1;if(""!=t&&t.length<1)return $("#keywords").focus(),layer.tips("关键词不能少于1个字","#keywords",{time:2e3,tips:[2,"#FF6666"]}),!1;if(-1==r){var o=$("#stTimeStr").val(),i=$("#edTimeStr").val();if(""==o&&""==i)return $("#edTimeStr").focus(),layer.tips("请输入搜索起始时间","#edTimeStr",{time:2e3,tips:[2,"#FF6666"]}),!1}$("#fid").val(e),$("#searchform").submit()})},Threads.selectForum=function(o){for(var i="<option value=''>请选择</option>",e=$(".forum-select").index($(o))+2;e<$(".forum-select").length;e++){var t=$($(".forum-select").get(e));t.empty(),t.append(i)}$(o).nextAll("select").first().empty(),""!=$(o).val()?Ajax.post(CONTEXT_PATH+"/forum/getChildForums",{fid:$(o).val()},function(e){if(e.result="success"){for(var t=e.responseData,a=0;a<t.length;a++){var r=t[a];i+="<option value='"+r.fid+"'>"+r.name+"</option>"}console.log($(o).attr("id")),console.log($(o).nextAll("select").first().attr("id")),$(o).nextAll("select").first().append(i)}}):$(o).nextAll("select").first().append(i)},Threads.goToTypeList=function(e){var t=["fid","typeId","domainId","state"],a=Common.getPageParamsByRequest(t);$("#category-box").find("a").removeClass("jqTransformChecked"),$("#type_"+e).parent().find("a").addClass("jqTransformChecked"),a.typeId=e,Common.locateUrlByParams(a,t)},Threads.goToDomainList=function(e){var t=["fid","typeId","domainId","state"],a=Common.getPageParamsByRequest(t);$("#field-box").find("a").removeClass("jqTransformChecked"),$("#domain_"+e).parent().find("a").addClass("jqTransformChecked"),a.domainId=e,Common.locateUrlByParams(a,t)},Threads.initPcMap=function(){window.addEventListener("message",function(e){var t=e.data;if(t&&"locationPicker"==t.module){"我的位置"===t.poiname?parent.Threads.placePC.setThreadPlace(t.poiaddress):parent.Threads.placePC.setThreadPlace(t.poiaddress+"("+t.poiname+")"),parent.Threads.placePC.setLongitude(t.latlng.lng),parent.Threads.placePC.setLatitude(t.latlng.lat);var a=parent.layer.getFrameIndex(window.name);parent.layer.close(a)}},!0)},Threads.placePC={setThreadPlace:function(e){e&&(threadPlace=e,$("#j_threadPlace").val(threadPlace),console.log($("#j_threadPlace").val()),$("#place_btn").text(threadPlace),$("#del_place_btn").show(),$("#noPublic").show(),console.log("threadPlace",threadPlace))},getThreadPlace:function(){return threadPlace},setLongitude:function(e){e&&(longitude=e,$("#j_longitude").val(longitude))},getLongitude:function(){return longitude},setLatitude:function(e){e&&(latitude=e,$("#j_latitude").val(latitude))},getLatitude:function(){return latitude}},$(function(){$("#public_place").on("click",function(){1===$(this).data("public-place")?($(this).removeClass("disabled").data("public-place",0),$("#input_public_place").val(0)):($(this).addClass("disabled").data("public-place",1),$("#input_public_place").val(1)),console.info($("#input_public_place").val())}),$("#place_btn").on("click",function(){parent.layer.open({type:2,closeBtn:1,area:["60%","80%"],title:!1,content:CONTEXT_PATH+"/threads/positionMap"})})}),Threads.checkCount=function(){var result=!0;return $.ajax({url:CONTEXT_PATH+"/user/checkThreadsCount",type:"post",async:!1,success:function(data){var data=eval("("+data+")");"success"==data.result&&data.responseData.count<=0&&(layer.alert(data.responseData.msg+"</br><a href='http://liuyan.people.com.cn/static/www/js/"+CONTEXT_PATH+"/help?cat=2#2-2-9'>查看详情</a>",{icon:5}),result=!1)}}),result},Threads.qyThreadsJsonData=function(e,t,a){$.ajax({type:"get",url:e,cache:!1,dataType:"jsonp",jsonp:"callback",jsonpCallback:t,success:function(e){a(e)},error:function(e,t,a){console.log(e.status),console.log(e.readyState),console.log(t)}})};